generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ----------------------------------------------------------------------
// IDENTITY & ACCESS (RBAC)
// ----------------------------------------------------------------------

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  fullName     String?
  role         String  @default("USER") // Simplified enum for SQLite
  status       String  @default("ACTIVE")

  // Relations
  issuerId   String?
  issuer     Issuer?   @relation(fields: [issuerId], references: [id])
  merchantId String?
  merchant   Merchant? @relation(fields: [merchantId], references: [id])

  wallets      Wallet[]
  attestations ComplianceAttestation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------------------------
// ENTITIES (Issuers & Merchants)
// ----------------------------------------------------------------------

model Issuer {
  id     String @id @default(uuid())
  name   String @unique // e.g., "SkyHigh Airlines"
  slug   String @unique
  apiKey String @unique // Internal API key for machine access

  // Relations
  users      User[]
  creditDefs VCreditDefinition[]
  policies   Policy[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Merchant {
  id       String @id @default(uuid())
  name     String @unique // e.g., "Coffee Chain X"
  category String // MCC code or internal category

  discountRate Decimal @default(0.0) // E.g., 0.10 for 10% discount

  // Relations
  users     User[]
  terminals MerchantTerminal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MerchantTerminal {
  id         String   @id @default(uuid())
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])
  location   String
  secretKey  String // For POS integration

  createdAt DateTime @default(now())
}

// ----------------------------------------------------------------------
// ASSETS (vCredits)
// ----------------------------------------------------------------------

model VCreditDefinition {
  id       String @id @default(uuid())
  issuerId String
  issuer   Issuer @relation(fields: [issuerId], references: [id])

  name     String // e.g., "SkyMiles"
  symbol   String // e.g., "SKY"
  decimals Int    @default(2)

  // Metadata
  type                String // Enum as String
  exchangeRateBaseUSD Decimal @default(0.01) // Indicative value

  // Relations
  balances      Balance[]
  policies      Policy[]
  liquidityPool LiquidityPool?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LiquidityPool {
  id          String            @id @default(uuid())
  creditDefId String            @unique
  creditDef   VCreditDefinition @relation(fields: [creditDefId], references: [id])

  balance  Decimal @default(0) // Fiat value available for redemptions
  currency String  @default("USD")

  updatedAt DateTime @updatedAt
}

model Wallet {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  type   String @default("CONSUMER") // Enum as String
  status String @default("ACTIVE")

  // Relations
  balances     Balance[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Balance {
  id       String @id @default(uuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  creditDefId String
  creditDef   VCreditDefinition @relation(fields: [creditDefId], references: [id])

  amount Decimal @default(0)

  updatedAt DateTime @updatedAt

  @@unique([walletId, creditDefId])
}

// ----------------------------------------------------------------------
// LEDGER & TRANSACTIONS
// ----------------------------------------------------------------------

model Transaction {
  id           String  @id @default(uuid())
  referenceRef String? @unique // External idempotent key
  type         String // Enum
  status       String  @default("PENDING")

  // Participants
  senderWalletId    String?
  senderWallet      Wallet? @relation(fields: [senderWalletId], references: [id]) // Null for Mint
  recipientWalletId String? // Null for Burn

  // Metadata
  metadata String? // SQLite doesn't support JSON type well in Prisma, using String

  // Audit
  policyLogId String?
  policyLog   PolicyEvaluationLog? @relation(fields: [policyLogId], references: [id])

  ledgerEntries LedgerEntry[]

  createdAt   DateTime  @default(now())
  finalizedAt DateTime?
}

model LedgerEntry {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  walletId    String
  creditDefId String

  direction String // DEBIT or CREDIT
  amount    Decimal

  balanceAfter Decimal // Snapshot for audit

  createdAt DateTime @default(now())
}

// ----------------------------------------------------------------------
// POLICY ENGINE
// ----------------------------------------------------------------------

model Policy {
  id       String  @id @default(uuid())
  issuerId String?
  issuer   Issuer? @relation(fields: [issuerId], references: [id])

  creditDefId String?
  creditDef   VCreditDefinition? @relation(fields: [creditDefId], references: [id])

  name        String
  description String?

  // Logic
  ruleType   String
  parameters String // JSON stringified
  isActive   Boolean @default(true)
  priority   Int     @default(0) // Higher executes first

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PolicyEvaluationLog {
  id            String  @id @default(uuid())
  transactionId String? // Can be null if check failed before tx creation

  decision String
  results  String // JSON stringified

  transactions Transaction[]

  createdAt DateTime @default(now())
}

// ----------------------------------------------------------------------
// COMPLIANCE
// ----------------------------------------------------------------------

model ComplianceAttestation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type     String
  provider String // e.g., "SumSub", "Onfido"
  status   String

  validUntil DateTime?
  metadata   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
